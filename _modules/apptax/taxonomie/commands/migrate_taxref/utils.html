<!DOCTYPE html>
<html class="writer-html5" lang="fr" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>apptax.taxonomie.commands.migrate_taxref.utils &mdash; Documentation GeoNature 2.0</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=e8570148"></script>
        <script src="../../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../../_static/translations.js?v=d99ca74e"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            GeoNature
              <img src="../../../../../_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">INSTALLATION</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../CHANGELOG.html">CHANGELOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../api-references.html">API REFERENCES</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">GeoNature</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Code du module</a></li>
          <li class="breadcrumb-item"><a href="../migrate_taxref.html">apptax.taxonomie.commands.migrate_taxref</a></li>
      <li class="breadcrumb-item active">apptax.taxonomie.commands.migrate_taxref.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Code source de apptax.taxonomie.commands.migrate_taxref.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>

<span class="kn">from</span> <span class="nn">alembic.migration</span> <span class="kn">import</span> <span class="n">MigrationContext</span>
<span class="kn">from</span> <span class="nn">alembic.script</span> <span class="kn">import</span> <span class="n">ScriptDirectory</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">ProgrammingError</span>


<span class="kn">from</span> <span class="nn">apptax.database</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">.queries</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EXPORT_QUERIES_MISSING_CD_NOMS_IN_DB</span><span class="p">,</span>
    <span class="n">EXPORT_QUERIES_MODIFICATION_NB</span><span class="p">,</span>
    <span class="n">EXPORT_QUERIES_MODIFICATION_LIST</span><span class="p">,</span>
    <span class="n">EXPORT_QUERIES_CONFLICTS</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="analyse_taxref_changes">
<a class="viewcode-back" href="../../../../../autoapi/apptax/taxonomie/commands/migrate_taxref/utils/index.html#apptax.taxonomie.commands.migrate_taxref.utils.analyse_taxref_changes">[docs]</a>
<span class="k">def</span> <span class="nf">analyse_taxref_changes</span><span class="p">(</span>
    <span class="n">keep_missing_cd_nom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">script_predetection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">script_postdetection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyse des répercussions de changement de taxref</span>

<span class="sd">    3 étapes :</span>
<span class="sd">        - Detection des cd_noms manquants</span>
<span class="sd">        - Création d&#39;une copie de travail de bib_noms</span>
<span class="sd">        - Analyse des modifications taxonomique (split, merge, ...) et</span>
<span class="sd">            de leur répercussion sur les attributs et medias de taxhub</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Test missing cd_nom</span>
    <span class="n">create_copy_bib_noms</span><span class="p">(</span><span class="n">keep_missing_cd_nom</span><span class="p">)</span>

    <span class="c1"># Change detection and repport</span>
    <span class="n">nb_of_conflict</span> <span class="o">=</span> <span class="n">detect_changes</span><span class="p">(</span>
        <span class="n">script_predetection</span><span class="o">=</span><span class="n">script_predetection</span><span class="p">,</span> <span class="n">script_postdetection</span><span class="o">=</span><span class="n">script_postdetection</span>
    <span class="p">)</span>
    <span class="c1"># si conflit &gt; 1 exit()</span>
    <span class="k">if</span> <span class="n">nb_of_conflict</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There is </span><span class="si">{</span><span class="n">nb_of_conflict</span><span class="si">}</span><span class="s2"> unresolved conflits. You can&#39;t continue migration&quot;</span>
        <span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>

    <span class="c1"># test if deleted cd_nom can be correct without manual intervention</span>
    <span class="c1"># And keep_missing_cd_nom is not set</span>
    <span class="k">if</span> <span class="n">test_missing_cd_nom</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keep_missing_cd_nom</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Some cd_nom will disappear without substitute. You can&#39;t continue migration. Analyse exports files&quot;</span>
        <span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span></div>



<div class="viewcode-block" id="create_copy_bib_noms">
<a class="viewcode-back" href="../../../../../autoapi/apptax/taxonomie/commands/migrate_taxref/utils/index.html#apptax.taxonomie.commands.migrate_taxref.utils.create_copy_bib_noms">[docs]</a>
<span class="k">def</span> <span class="nf">create_copy_bib_noms</span><span class="p">(</span><span class="n">keep_missing_cd_nom</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Création d&#39;une table copie de bib_noms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create working copy of bib_noms…&quot;</span><span class="p">)</span>

    <span class="c1"># Préparation création de table temporaire permettant d&#39;importer taxref</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span>
        <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span>
            <span class="s2">&quot;apptax.taxonomie.commands.migrate_taxref.data.changes_detection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;0.1_generate_tmp_bib_noms_copy.sql&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keep_missing_cd_nom</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            UPDATE taxonomie.tmp_bib_noms_copy tbnc  SET deleted = FALSE WHERE deleted = TRUE;</span>
<span class="sd">        &quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>



<div class="viewcode-block" id="detect_changes">
<a class="viewcode-back" href="../../../../../autoapi/apptax/taxonomie/commands/migrate_taxref/utils/index.html#apptax.taxonomie.commands.migrate_taxref.utils.detect_changes">[docs]</a>
<span class="k">def</span> <span class="nf">detect_changes</span><span class="p">(</span><span class="n">script_predetection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">script_postdetection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detection des changements et de leur implication</span>
<span class="sd">        sur bib_noms, les attributs et les médias</span>

<span class="sd">    :return: Nombre de conflit detecté</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span>
        <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span>
            <span class="s2">&quot;apptax.taxonomie.commands.migrate_taxref.data.changes_detection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1.1_taxref_changes_detections.sql&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">script_predetection</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run script </span><span class="si">{</span><span class="n">script_predetection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">script_predetection</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error un sql script </span><span class="si">{</span><span class="n">script_predetection</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span>
        <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span>
            <span class="s2">&quot;apptax.taxonomie.commands.migrate_taxref.data.changes_detection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1.2_taxref_changes_detections_cas_actions.sql&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">script_postdetection</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run script </span><span class="si">{</span><span class="n">script_postdetection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">script_postdetection</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error un sql script </span><span class="si">{</span><span class="n">script_postdetection</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Export des changements</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">EXPORT_QUERIES_MODIFICATION_NB</span><span class="p">))</span>
    <span class="n">export_as_csv</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;nb_changements.csv&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">EXPORT_QUERIES_MODIFICATION_LIST</span><span class="p">))</span>
    <span class="n">export_as_csv</span><span class="p">(</span>
        <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;liste_changements.csv&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of taxref changes done in tmp&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">EXPORT_QUERIES_CONFLICTS</span><span class="p">))</span>
    <span class="n">nb_of_conflict</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">nb_of_conflict</span></div>



<div class="viewcode-block" id="save_data">
<a class="viewcode-back" href="../../../../../autoapi/apptax/taxonomie/commands/migrate_taxref/utils/index.html#apptax.taxonomie.commands.migrate_taxref.utils.save_data">[docs]</a>
<span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">keep_taxref</span><span class="p">,</span> <span class="n">keep_bdc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sauvegarde des données de l&#39;ancienne version de taxref</span>

<span class="sd">    :param version: numéro de version de taxref</span>
<span class="sd">    :type version: int</span>
<span class="sd">    :param keep_taxref: Indique si l&#39;on souhaite concerver l&#39;ancienne version du referentiel taxref</span>
<span class="sd">    :type keep_taxref: boolean</span>
<span class="sd">    :param keep_bdc:  Indique si l&#39;on souhaite concerver l&#39;ancienne version du referentiel bdc_status</span>
<span class="sd">    :type keep_bdc: boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">keep_taxref</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            DROP TABLE IF EXISTS taxonomie.taxref_v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            CREATE TABLE taxonomie.taxref_v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">            SELECT * FROM taxonomie.taxref;</span>
<span class="s2">        &quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">keep_bdc</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            DROP TABLE IF EXISTS taxonomie.bdc_statut_v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            CREATE TABLE taxonomie.bdc_statut_v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">            SELECT * FROM taxonomie.bdc_statut;</span>
<span class="s2">        &quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            DROP TABLE IF EXISTS taxonomie.bdc_statut_type_v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            CREATE TABLE taxonomie.bdc_statut_type_v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">            SELECT * FROM taxonomie.bdc_statut_type;</span>
<span class="s2">        &quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="missing_cd_nom_query">
<a class="viewcode-back" href="../../../../../autoapi/apptax/taxonomie/commands/migrate_taxref/utils/index.html#apptax.taxonomie.commands.migrate_taxref.utils.missing_cd_nom_query">[docs]</a>
<span class="k">def</span> <span class="nf">missing_cd_nom_query</span><span class="p">(</span><span class="n">query_name</span><span class="p">,</span> <span class="n">export_file_name</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">query_name</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Some cd_nom referencing in data where missing from taxref v15 -&gt; see file </span><span class="si">{</span><span class="n">export_file_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">export_as_csv</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">export_file_name</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Test if there is a substition cd_nom for bib_noms only</span>
    <span class="n">nb_missing_cd_nom</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;taxonomie.bib_noms&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cd_nom_remplacement&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No substitition for cd_nom </span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;nom_complet&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> in table </span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">nb_missing_cd_nom</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;taxonomie.bib_noms&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cd_nom </span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;cd_nom&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;nom_complet&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) will disappear in table </span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">nb_missing_cd_nom</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">nb_missing_cd_nom</span></div>



<div class="viewcode-block" id="test_missing_cd_nom">
<a class="viewcode-back" href="../../../../../autoapi/apptax/taxonomie/commands/migrate_taxref/utils/index.html#apptax.taxonomie.commands.migrate_taxref.utils.test_missing_cd_nom">[docs]</a>
<span class="k">def</span> <span class="nf">test_missing_cd_nom</span><span class="p">():</span>
    <span class="c1"># test cd_nom disparus</span>
    <span class="n">missing_cd_nom_gn2</span> <span class="o">=</span> <span class="n">missing_cd_nom_query</span><span class="p">(</span>
        <span class="n">query_name</span><span class="o">=</span><span class="n">EXPORT_QUERIES_MISSING_CD_NOMS_IN_DB</span><span class="p">,</span>
        <span class="n">export_file_name</span><span class="o">=</span><span class="s2">&quot;missing_cd_nom_into_database.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">missing_cd_nom_gn2</span></div>



<div class="viewcode-block" id="export_as_csv">
<a class="viewcode-back" href="../../../../../autoapi/apptax/taxonomie/commands/migrate_taxref/utils/index.html#apptax.taxonomie.commands.migrate_taxref.utils.export_as_csv">[docs]</a>
<span class="k">def</span> <span class="nf">export_as_csv</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
    <span class="n">export_dir</span> <span class="o">=</span> <span class="s2">&quot;tmp&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">export_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">export_dir</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2018-2023, PnE, PnC.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>