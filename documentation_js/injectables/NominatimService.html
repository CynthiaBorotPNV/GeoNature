<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>geonature documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top d-block d-sm-none">
            <a href="../" class="navbar-brand">geonature documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >NominatimService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/GN2CommonModule/map/map.component.ts</code>
        </p>





            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#config" >config</a>
                            </li>
                            <li>
                                <a href="#PARAMS" >PARAMS</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#search" >search</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(http: HttpClient, config: <a href="../injectables/ConfigService.html" target="_self">ConfigService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="26" class="link-to-prism">src/app/GN2CommonModule/map/map.component.ts:26</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>http</td>
                                                  
                                                        <td>
                                                                    <code>HttpClient</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>config</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/ConfigService.html" target="_self" >ConfigService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="search"></a>
                    <span class="name">
                        <span ><b>search</b></span>
                        <a href="#search"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>search(term: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="42"
                                    class="link-to-prism">src/app/GN2CommonModule/map/map.component.ts:42</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>term</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="config"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>config</b></span>
                        <a href="#config"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/ConfigService.html" target="_self" >ConfigService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="30" class="link-to-prism">src/app/GN2CommonModule/map/map.component.ts:30</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="PARAMS"></a>
                    <span class="name">
                        <span ><b>PARAMS</b></span>
                        <a href="#PARAMS"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>null</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>null</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="26" class="link-to-prism">src/app/GN2CommonModule/map/map.component.ts:26</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, Input, OnInit, ViewChild, Injectable } from &#x27;@angular/core&#x27;;
import { MapService } from &#x27;./map.service&#x27;;
import { Map, LatLngExpression, LatLngBounds } from &#x27;leaflet&#x27;;
import { HttpClient, HttpParams } from &#x27;@angular/common/http&#x27;;
import * as L from &#x27;leaflet&#x27;;
import { CommonService } from &#x27;../service/common.service&#x27;;

import &#x27;leaflet-draw&#x27;;
import &#x27;leaflet.locatecontrol&#x27;;
import { UntypedFormControl } from &#x27;@angular/forms&#x27;;
import { Observable, of } from &#x27;rxjs&#x27;;
import {
  catchError,
  debounceTime,
  distinctUntilChanged,
  tap,
  switchMap,
  map,
} from &#x27;rxjs/operators&#x27;;
import { ConfigService } from &#x27;@geonature/services/config.service&#x27;;

const NOMINATIM_URL &#x3D; &#x27;https://nominatim.openstreetmap.org/search&#x27;;

@Injectable()
export class NominatimService {
  PARAMS &#x3D; null;

  constructor(
    private http: HttpClient,
    public config: ConfigService
  ) {
    this.PARAMS &#x3D; new HttpParams({
      fromObject: {
        format: &#x27;json&#x27;,
        limit: &#x27;10&#x27;,
        polygon_geojson: &#x27;1&#x27;,
        countrycodes: this.config.MAPCONFIG.OSM_RESTRICT_COUNTRY_CODES,
      },
    });
  }

  search(term: string) {
    if (term &#x3D;&#x3D;&#x3D; &#x27;&#x27;) {
      return of([]);
    }

    return this.http
      .get(NOMINATIM_URL, { params: this.PARAMS.set(&#x27;q&#x27;, term) })
      .pipe(map((res) &#x3D;&gt; res));
  }
}

/**
 * Ce composant affiche une carte Leaflet ainsi qu&#x27;un outil de recherche de lieux dits et d&#x27;adresses (basé sur l&#x27;API OpenStreetMap).
 * @example
 * &lt;pnx-map height&#x3D;&quot;80vh&quot; [center]&#x3D;&quot;center&quot; [zoom]&#x3D;&quot;zoom&quot; &gt; &lt;/pnx-map&gt;&#x60;
 */
@Component({
  selector: &#x27;pnx-map&#x27;,
  templateUrl: &#x27;./map.component.html&#x27;,
  styleUrls: [&#x27;./map.component.scss&#x27;],
  providers: [NominatimService],
})
export class MapComponent implements OnInit {
  /**
   *  coordonnées du centrage de la carte: [long,lat]
   */
  @Input() center: Array&lt;number&gt;;
  /** Niveaux de zoom à l&#x27;initialisation de la carte */
  @Input() zoom: number &#x3D; null;
  /** Hauteur de la carte (obligatoire) */
  @Input() height: string;

  /*@Input() mapContainer: string &#x3D; &#x27;map&#x27;;*/

  /** Activer la barre de recherche */
  @Input() searchBar: boolean &#x3D; true;

  /**Ajouter un bouton de géolocalisation */
  @Input() geolocation: boolean &#x3D; false;

  @ViewChild(&#x27;mapDiv&#x27;, { static: true }) mapContainer;
  searchLocation: string;
  public searching &#x3D; false;
  public searchFailed &#x3D; false;
  public locationControl &#x3D; new UntypedFormControl();
  public map: Map;
  constructor(
    private mapService: MapService,
    private _commonService: CommonService,
    private _nominatim: NominatimService,
    public config: ConfigService
  ) {
    this.searchLocation &#x3D; &#x27;&#x27;;
    this.zoom &#x3D; this.config.MAPCONFIG.ZOOM_LEVEL;
  }

  ngOnInit() {
    this.initialize();
  }

  search &#x3D; (text$: Observable&lt;string&gt;) &#x3D;&gt;
    text$.pipe(
      debounceTime(300),
      distinctUntilChanged(),
      tap(() &#x3D;&gt; (this.searching &#x3D; true)),
      switchMap((term) &#x3D;&gt;
        this._nominatim.search(term).pipe(
          tap(() &#x3D;&gt; (this.searchFailed &#x3D; false)),
          catchError(() &#x3D;&gt; {
            this._commonService.translateToaster(&#x27;Warning&#x27;, &#x27;Map.LocationError&#x27;);
            this.searchFailed &#x3D; true;
            return of([]);
          })
        )
      ),
      tap(() &#x3D;&gt; (this.searching &#x3D; false))
    );

  onResultSelected(nomatimObject) {
    let bounds: LatLngBounds;
    if (nomatimObject.item?.geojson) {
      const geojson &#x3D; L.geoJSON(nomatimObject.item.geojson);
      bounds &#x3D; geojson.getBounds();
    } else {
      const boundingBox: number[] &#x3D; nomatimObject.item.boundingbox;
      bounds &#x3D; L.latLngBounds(
        L.latLng(boundingBox[0], boundingBox[2]),
        L.latLng(boundingBox[1], boundingBox[3])
      );
    }
    this.map.fitBounds(bounds);
  }

  initialize() {
    let center: LatLngExpression;
    if (this.center !&#x3D;&#x3D; undefined) {
      center &#x3D; L.latLng(this.center[0], this.center[1]);
    } else {
      center &#x3D; L.latLng(this.config.MAPCONFIG.CENTER[0], this.config.MAPCONFIG.CENTER[1]);
    }
    // MAP
    const map &#x3D; L.map(this.mapContainer.nativeElement, {
      zoomControl: false,
      center: center,
      zoom: this.zoom,
      preferCanvas: true,
    });
    this.map &#x3D; map;
    (map as any)._onResize();

    // ZOOM CONTROL
    L.control.zoom({ position: &#x27;topright&#x27; }).addTo(map);

    // SCALE
    L.control.scale().addTo(map);

    // geoloc
    if (this.geolocation &amp;&amp; this.config.MAPCONFIG.GEOLOCATION) {
      (L.control as any).locate().addTo(map);
    }

    // LAYERS CONTROL
    // Baselayers
    const baseControl &#x3D; {};
    const BASEMAP &#x3D; JSON.parse(JSON.stringify(this.config.MAPCONFIG.BASEMAP));
    BASEMAP.forEach((basemap, index) &#x3D;&gt; {
      const formatedBasemap &#x3D; this.formatBaseMapConfig(basemap);
      if (basemap.service &#x3D;&#x3D;&#x3D; &#x27;wms&#x27;) {
        baseControl[formatedBasemap.name] &#x3D; L.tileLayer.wms(
          formatedBasemap.url,
          formatedBasemap.options
        );
      } else {
        baseControl[formatedBasemap.name] &#x3D; L.tileLayer(
          formatedBasemap.url,
          formatedBasemap.options
        );
      }
      if (index &#x3D;&#x3D;&#x3D; 0) {
        map.addLayer(baseControl[basemap.name]);
      }
    });
    // overlays layers
    const overlaysLayers &#x3D; this.mapService.createOverLayers(map);
    // create control layers
    this.mapService.layerControl &#x3D; L.control.layers(baseControl, overlaysLayers, {
      sortLayers: false, // When false, layers will keep the order in which they were added to the control
      collapsed: true, //If true, the control will be collapsed into an icon and expanded on mouse hover
    });
    this.mapService.layerControl.addTo(map);

    this.mapService.setMap(map);
    this.mapService.initializeLeafletDrawFeatureGroup();
    // GET EXTEND ON EACH ZOOM
    map.on(&#x27;moveend&#x27;, (e) &#x3D;&gt; {
      const zoom &#x3D; this.map.getZoom();
      // keep current extend only if current zoom !&#x3D; 0
      if (zoom !&#x3D;&#x3D; 0) {
        this.mapService.currentExtend &#x3D; {
          center: this.map.getCenter(),
          zoom: this.map.getZoom(),
        };
      }
    });

    // on L.controler.layers add over layer to map
    map.on(&#x27;overlayadd&#x27;, (overlay) &#x3D;&gt; {
      // once - load JSON or WFS overlay data async if not already loaded
      this.mapService.loadOverlay(overlay);
    });

    map.on(&#x27;baselayerchange&#x27;, (layer) &#x3D;&gt; {
      localStorage.setItem(&#x27;MapLayer&#x27;, layer.name);
    });

    const userMapLayer &#x3D; localStorage.getItem(&#x27;MapLayer&#x27;);
    if (userMapLayer !&#x3D;&#x3D; null &amp;&amp; baseControl[userMapLayer] !&#x3D;&#x3D; undefined) {
      map.addLayer(baseControl[userMapLayer]);
    }

    setTimeout(() &#x3D;&gt; {
      this.map.invalidateSize();
    }, 50);
  }

  /** Retrocompatibility hack to format map config to the expected format:
   *
   {
    name: string,
    url: string,
    service?: wms|wmts|null
    options?: {
        layer?: string,
        attribution?: string,
        format?: string
        [...]
    }
  }
   */
  formatBaseMapConfig(baseMap) {
    // eslint-disable-next-line guard-for-in
    for (let attr in baseMap) {
      if (attr &#x3D;&#x3D;&#x3D; &#x27;layer&#x27;) {
        baseMap[&#x27;url&#x27;] &#x3D; baseMap[attr];
        delete baseMap[&#x27;layer&#x27;];
      }
      if (![&#x27;url&#x27;, &#x27;layer&#x27;, &#x27;name&#x27;, &#x27;service&#x27;, &#x27;options&#x27;].includes(attr)) {
        if (!baseMap[&#x27;options&#x27;]) {
          baseMap[&#x27;options&#x27;] &#x3D; {};
        }
        baseMap[&#x27;options&#x27;][attr] &#x3D; baseMap[attr];
        delete baseMap[attr];
      }
    }
    return baseMap;
  }

  formatter(nominatim) {
    return nominatim.display_name;
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'NominatimService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
